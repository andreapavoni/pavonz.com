<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pavonz.com</title>
    <link rel="stylesheet" href="https://pavonz.com/app.css" />
  </head>
  <body>
    <header class="root">
      <section class="container">
        <nav>
          <ul>
            <li><a href="/">home</a></li>
            <li><a href="/blog">blog</a></li>
          </ul>
        </nav>
        <h1><a href="/">~/pavonz</a></h1>
      </section>
    </header>

    <main class="container">
<h1 class="title">Create recursive OpenStruct from a Ruby Hash</h1>
<p class="subtitle"><strong>2013-04-24</strong></p>
<p>When I develop some ruby app, mostly rails ones, I need to manage several configuration variables (eg: API keys) and I like to store them in a unique place. So I usually end up with something like this:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># config/initializers/_load_config.rb
</span><span>
</span><span>path = </span><span style="color:#ebcb8b;">File</span><span>.read(&quot;#{</span><span style="color:#ebcb8b;">Rails</span><span>.root}</span><span style="color:#a3be8c;">/config/config.yml</span><span>&quot;)
</span><span>
</span><span>APP_CONF = </span><span style="color:#ebcb8b;">ActiveSupport</span><span>::</span><span style="color:#ebcb8b;">HashWithIndifferentAccess</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(
</span><span>  </span><span style="color:#ebcb8b;">YAML</span><span>.</span><span style="color:#96b5b4;">load</span><span>(</span><span style="color:#ebcb8b;">ERB</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(path).result)[</span><span style="color:#ebcb8b;">Rails</span><span>.env]
</span><span>)
</span></code></pre>
<p>It does a good job:</p>
<ul>
<li>it first compiles eventual ERB tags (so you can store values in <code>ENV</code>)</li>
<li>then it loads YAML</li>
<li>finally initializes a <a href="http://apidock.com/rails/v3.2.13/ActiveSupport/HashWithIndifferentAccess/new/class">HashWithIndifferentAccess</a>, so I can lookup keys with either a String or a Symbol</li>
</ul>
<p>The last point is a <em>plus</em>, kindly offered by Rails' ActiveSupport library, I prefer Symbol over String for Hash keys.</p>
<h3 id="the-problem">The problem</h3>
<p>However, I knew that there's a smarter way to achieve same goal, even with some more adavantages. I started from <a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/ostruct/rdoc/OpenStruct.html">OpenStruct</a>:</p>
<ul>
<li>it solves the problem of Hash key lookup by providing them as methods, for example:</li>
</ul>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">ostruct</span><span>&#39;
</span><span>
</span><span style="color:#96b5b4;">hash </span><span>= {</span><span style="color:#a3be8c;">a: </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#a3be8c;">b: </span><span style="color:#d08770;">2</span><span>}
</span><span>mystruct = </span><span style="color:#ebcb8b;">OpenStruct</span><span>.</span><span style="color:#8fa1b3;">new </span><span style="color:#96b5b4;">hash
</span><span>mystruct.a </span><span style="color:#65737e;"># =&gt; 1
</span><span>mystruct.b </span><span style="color:#65737e;"># =&gt; 2
</span></code></pre>
<ul>
<li>it's part of the Ruby's standard library (along with YAML and ERB as well)</li>
<li>it's very simple to hack ;-)</li>
</ul>
<p>Looks excellent, right? Well, it's not <em>perfect</em>, because it doesn't handle nested hashes, in other words, here's what happen when you pass an Hash that has other hashes as values:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">ostruct</span><span>&#39;
</span><span>
</span><span style="color:#96b5b4;">hash </span><span>= {</span><span style="color:#a3be8c;">a: </span><span>{</span><span style="color:#a3be8c;">b: </span><span style="color:#d08770;">1</span><span>}}
</span><span>mystruct = </span><span style="color:#ebcb8b;">OpenStruct</span><span>.</span><span style="color:#8fa1b3;">new </span><span style="color:#96b5b4;">hash
</span><span>mystruct.a </span><span style="color:#65737e;"># =&gt; {b: 1}
</span><span>mystruct.a.b </span><span style="color:#65737e;"># =&gt; NoMethodError: undefined method &#39;b&#39; for {:b=&gt;1}:Hash
</span></code></pre>
<p>Moreover, there's no way to access the original hash (well, there's one but that's another point), it might be useful when you need to pass an entire Hash.</p>
<h3 id="a-solution">A solution</h3>
<p><code>OpenStruct</code> already does a great part fo the <em>dirty job</em>, it only needs some change to get what we need. I called it, <code>DeepStruct</code>:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># deep_struct.rb
</span><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">ostruct</span><span>&#39;
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">DeepStruct </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">OpenStruct
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">initialize</span><span>(</span><span style="color:#bf616a;">hash</span><span>=</span><span style="color:#d08770;">nil</span><span>)
</span><span>    @</span><span style="color:#bf616a;">table </span><span>= {}
</span><span>    @</span><span style="color:#bf616a;">hash_table </span><span>= {}
</span><span>
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">hash
</span><span>      </span><span style="color:#96b5b4;">hash</span><span>.each </span><span style="color:#b48ead;">do </span><span>|</span><span style="color:#bf616a;">k</span><span>,</span><span style="color:#bf616a;">v</span><span>|
</span><span>        @</span><span style="color:#bf616a;">table</span><span>[k.</span><span style="color:#96b5b4;">to_sym</span><span>] = (v.</span><span style="color:#96b5b4;">is_a?</span><span>(</span><span style="color:#96b5b4;">Hash</span><span>) ? </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#96b5b4;">class</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(v) : v)
</span><span>        @</span><span style="color:#bf616a;">hash_table</span><span>[k.</span><span style="color:#96b5b4;">to_sym</span><span>] = v
</span><span>
</span><span>        new_ostruct_member(k)
</span><span>      </span><span style="color:#b48ead;">end
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">to_h
</span><span>    @</span><span style="color:#bf616a;">hash_table
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>There's not too much to explain here, I've overridden <a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/ostruct/rdoc/OpenStruct.html#method-c-new">OpenStruct#new</a> method to make two basic things:</p>
<ul>
<li>Iterate the key/values of the passed Hash, then:
<ul>
<li>initialize a new <code>DeepStruct</code> if a given value is an Hash</li>
<li>store original key/values in @hash_table, so I can retrieve it with <code>#to_h</code> method</li>
</ul>
</li>
</ul>
<p>That's all we need, here's an example:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">deep_struct</span><span>&#39;
</span><span>
</span><span style="color:#96b5b4;">hash </span><span>= {</span><span style="color:#a3be8c;">a: </span><span>{</span><span style="color:#a3be8c;">b: </span><span style="color:#d08770;">1</span><span>}}
</span><span>mystruct = </span><span style="color:#ebcb8b;">DeepStruct</span><span>.</span><span style="color:#8fa1b3;">new </span><span style="color:#96b5b4;">hash
</span><span>mystruct.a </span><span style="color:#65737e;"># =&gt; #&lt;DeepStruct b=1&gt;
</span><span>mystruct.a.b </span><span style="color:#65737e;"># =&gt; 1
</span><span>mystruct.a.</span><span style="color:#96b5b4;">to_h </span><span style="color:#65737e;"># =&gt; {b: 1}
</span></code></pre>
<h3 id="conclusion">Conclusion</h3>
<p>I've said I'd mainly use this to store configs for my apps, so go back to the initial example:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># config/initializers/_load_config.rb
</span><span>
</span><span>path = </span><span style="color:#ebcb8b;">File</span><span>.read(&quot;#{</span><span style="color:#ebcb8b;">Rails</span><span>.root}</span><span style="color:#a3be8c;">/config/config.yml</span><span>&quot;)
</span><span>
</span><span>APP_CONF = </span><span style="color:#ebcb8b;">DeepStruct</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#ebcb8b;">YAML</span><span>.</span><span style="color:#96b5b4;">load</span><span>(</span><span style="color:#ebcb8b;">ERB</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(path).result)[</span><span style="color:#ebcb8b;">Rails</span><span>.env])
</span></code></pre>
<p>Enjoy and/or leave a comment :-)</p>
 </main>
    <footer class="root">
      <section class="container">
        <small
          >built with <i class="hearth">&#10084;</i> by Andrea
          <i>pavonz</i> Pavoni &copy;2010-2022</small
        >
      </section>
    </footer>
    <script
      data-goatcounter="https://pavonz.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
