<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pavonz.com</title>
    <link rel="stylesheet" href="https://pavonz.com/app.css" />
  </head>
  <body>
    <header class="root">
      <section class="container">
        <nav>
          <ul>
            <li><a href="/">home</a></li>
            <li><a href="/blog">blog</a></li>
          </ul>
        </nav>
        <h1><a href="/">~/pavonz</a></h1>
      </section>
    </header>

    <main class="container">
<h1 class="title">Rails 3: An improved agnostic search model using Arel</h1>
<p class="subtitle"><strong>2010-07-05</strong></p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Search
</span><span style="color:#eff1f5;">  </span><span style="color:#8fa1b3;">attr_accessor </span><span style="color:#a3be8c;">:attributes
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">initialize</span><span>(</span><span style="color:#bf616a;">model</span><span>, </span><span style="color:#bf616a;">attrs </span><span>= {})
</span><span>    @</span><span style="color:#bf616a;">attributes </span><span>= {}
</span><span>    @</span><span style="color:#bf616a;">model </span><span>= model
</span><span>    @</span><span style="color:#bf616a;">arel </span><span>= model.arel_table
</span><span>
</span><span>    model.columns.each </span><span style="color:#b48ead;">do </span><span>|</span><span style="color:#bf616a;">field</span><span>|
</span><span>      pattr = field.</span><span style="color:#96b5b4;">name
</span><span>
</span><span>      attrs = </span><span style="color:#96b5b4;">Hash</span><span>[attrs.</span><span style="color:#96b5b4;">select </span><span>{|</span><span style="color:#bf616a;">k</span><span>,</span><span style="color:#bf616a;">v</span><span>| !v.empty? }]
</span><span>      searchable = !attrs[pattr].</span><span style="color:#96b5b4;">nil?
</span><span>
</span><span>      @</span><span style="color:#bf616a;">attributes</span><span>[pattr.</span><span style="color:#96b5b4;">to_sym</span><span>] = attrs[pattr] </span><span style="color:#b48ead;">if</span><span> searchable
</span><span>
</span><span>      </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#96b5b4;">class</span><span>.</span><span style="color:#96b5b4;">send</span><span>(</span><span style="color:#a3be8c;">:define_method</span><span>,field.</span><span style="color:#96b5b4;">name</span><span>) </span><span style="color:#b48ead;">do </span><span>|</span><span style="color:#bf616a;">cond</span><span>, *</span><span style="color:#bf616a;">value</span><span>|
</span><span>        </span><span style="color:#8fa1b3;">attr </span><span>= field.</span><span style="color:#96b5b4;">name</span><span>.</span><span style="color:#96b5b4;">to_sym
</span><span>        value = value.first || @</span><span style="color:#bf616a;">attributes</span><span>[</span><span style="color:#8fa1b3;">attr</span><span>] || </span><span style="color:#d08770;">nil
</span><span>        @</span><span style="color:#bf616a;">model </span><span>= @</span><span style="color:#bf616a;">model</span><span>.where(@</span><span style="color:#bf616a;">arel</span><span>[</span><span style="color:#8fa1b3;">attr</span><span>].</span><span style="color:#96b5b4;">send</span><span>(cond,value)) </span><span style="color:#b48ead;">if</span><span> searchable
</span><span>      </span><span style="color:#b48ead;">end
</span><span>    </span><span style="color:#b48ead;">end
</span><span>
</span><span>    </span><span style="color:#b48ead;">if block_given?
</span><span>      </span><span style="color:#b48ead;">yield </span><span style="color:#bf616a;">self
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">result
</span><span>    @</span><span style="color:#bf616a;">model
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>The constructor takes the model you want to search in, and an hash of params to use, they’ll be the request params when used from controller. Note that if some param value is an empty string, it will be ignored: this lets the visitor to leave blank some fields in the search form and make it conditional.</p>
<p>To save typings, when specifying conditions, you can omit the value, because it’s taken from the params hash. By the way, if you need some more control, you can specify another value. Finally, you can pass a block to make it easier to read. Here’s a real usage example from a controller:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">RealtyRequestController </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">ApplicationController
</span><span>  </span><span style="color:#65737e;">#... other actions ...
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">search
</span><span>    </span><span style="color:#65737e;"># value to search defaults to params[:search][:contract_id]
</span><span>    @</span><span style="color:#bf616a;">s </span><span>= </span><span style="color:#ebcb8b;">Search</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#bf616a;">RealtyRequest</span><span>,params[</span><span style="color:#a3be8c;">:search</span><span>]) </span><span style="color:#b48ead;">do </span><span>|</span><span style="color:#bf616a;">s</span><span>|
</span><span>      s.contract_id </span><span style="color:#a3be8c;">:eq
</span><span>      </span><span style="color:#65737e;"># same here
</span><span>      s.price_max </span><span style="color:#a3be8c;">:lteq
</span><span>      s.price_min </span><span style="color:#a3be8c;">:gteq
</span><span>      </span><span style="color:#65737e;"># here I look for &#39;%param%&#39;
</span><span>      s.zone </span><span style="color:#a3be8c;">:matches</span><span>, &quot;</span><span style="color:#a3be8c;">%</span><span>#{params[</span><span style="color:#a3be8c;">:search</span><span>][</span><span style="color:#a3be8c;">:zone</span><span>]}</span><span style="color:#a3be8c;">%</span><span>&quot;
</span><span>      s.province </span><span style="color:#a3be8c;">:matches</span><span>, &quot;</span><span style="color:#a3be8c;">%</span><span>#{params[</span><span style="color:#a3be8c;">:search</span><span>][</span><span style="color:#a3be8c;">:province</span><span>]}</span><span style="color:#a3be8c;">%</span><span>&quot;
</span><span>      s.municipality </span><span style="color:#a3be8c;">:matches</span><span>, &quot;</span><span style="color:#a3be8c;">%</span><span>#{params[</span><span style="color:#a3be8c;">:search</span><span>][</span><span style="color:#a3be8c;">:municipality</span><span>]}</span><span style="color:#a3be8c;">%</span><span>&quot;
</span><span>      s.rooms </span><span style="color:#a3be8c;">:eq
</span><span>      s.mq </span><span style="color:#a3be8c;">:eq
</span><span>    </span><span style="color:#b48ead;">end
</span><span>
</span><span>    </span><span style="color:#65737e;"># assign result
</span><span>    @</span><span style="color:#bf616a;">realty_requests </span><span>= @</span><span style="color:#bf616a;">s</span><span>.result
</span><span>    </span><span style="color:#65737e;"># add order option
</span><span>    @</span><span style="color:#bf616a;">realty_requests</span><span>.order(</span><span style="color:#a3be8c;">:created_at</span><span>)
</span><span>
</span><span>    </span><span style="color:#65737e;"># ... other rendering stuff ...
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>When <code>Search#result</code> is called a model instance is returned, it can still be ordered. According to <a href="http://github.com/rails/arel#readme">Arel's README</a>, there’s no support for <em>OR</em> conditions yet, I hope it will be included soon.</p>
 </main>
    <footer class="root">
      <section class="container">
        <small
          >built with <i class="hearth">&#10084;</i> by Andrea
          <i>pavonz</i> Pavoni &copy;2010-2022</small
        >
      </section>
    </footer>
    <script
      data-goatcounter="https://pavonz.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
