<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pavonz.com</title>
    <link rel="stylesheet" href="https://pavonz.com/app.css" />
  </head>
  <body>
    <header class="root">
      <section class="container">
        <nav>
          <ul>
            <li><a href="/">home</a></li>
            <li><a href="/blog">blog</a></li>
          </ul>
        </nav>
        <h1><a href="/">~/pavonz</a></h1>
      </section>
    </header>

    <main class="container">
<h1 class="title">Rails3: using Arel to make conditional searches based on conditional params</h1>
<p class="subtitle"><strong>2010-06-30</strong></p>
<p>I wrote a basic model called Search, I can re-use it for other models that need search features:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># put this in app/models/search.rb
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Search
</span><span style="color:#eff1f5;">  </span><span style="color:#8fa1b3;">attr_accessor </span><span style="color:#a3be8c;">:attributes
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">initialize</span><span>(</span><span style="color:#bf616a;">attributes </span><span>= {})
</span><span>    @</span><span style="color:#bf616a;">attributes </span><span>= attributes
</span><span>    @</span><span style="color:#bf616a;">attributes</span><span>.each </span><span style="color:#b48ead;">do </span><span>|</span><span style="color:#bf616a;">k</span><span>,</span><span style="color:#bf616a;">v</span><span>|
</span><span>      </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#96b5b4;">class</span><span>.</span><span style="color:#96b5b4;">send</span><span>(</span><span style="color:#a3be8c;">:define_method</span><span>,k) { v }
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>Then I wrote a partial form with params, the following code is only an example, I have more fields:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&lt;div id=&quot;searchform&quot;&gt;
</span><span>  &lt;%= form_tag search_people_path, :method =&gt; &#39;get&#39; do |f| %&gt;
</span><span>  &lt;div class=&quot;field&quot;&gt;
</span><span>    &lt;%= label :search, :firstname, &#39;Firstname&#39; %&gt;&lt;br /&gt;
</span><span>    &lt;%= text_field :search, :firstname %&gt;
</span><span>  &lt;/div&gt;
</span><span>  &lt;div class=&quot;field&quot;&gt;
</span><span>    &lt;%= label :search, :lastname, &#39;Lastname&#39; %&gt;&lt;br /&gt;
</span><span>    &lt;%= text_field :search, :lastname %&gt;
</span><span>  &lt;/div&gt;
</span><span>  &lt;%= submit_tag &quot;Search&quot; %&gt; &lt;% end %&gt;
</span><span>&lt;/div&gt;
</span></code></pre>
<p>Finally the controller action called ‘search’. As you can see, the difficult part was that you don’t know which params are passed by the request, so you need to specify conditions only if they are present. Arel helped to resolve this problem:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">PeopleController </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">ApplicationController
</span><span>  </span><span style="color:#65737e;"># ... other CRUD actions ...
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">search
</span><span>    q = </span><span style="color:#ebcb8b;">Person</span><span>.arel_table </span><span style="color:#65737e;"># initialize Arel table
</span><span>    @</span><span style="color:#bf616a;">people </span><span>= </span><span style="color:#ebcb8b;">Person</span><span>.order(</span><span style="color:#a3be8c;">:created_at</span><span>) </span><span style="color:#65737e;"># start with a simple option
</span><span>
</span><span>    </span><span style="color:#65737e;"># initialize Search model with the search params
</span><span>    @</span><span style="color:#bf616a;">search </span><span>= </span><span style="color:#ebcb8b;">Search</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(params[</span><span style="color:#a3be8c;">:search</span><span>])
</span><span>
</span><span>    </span><span style="color:#65737e;"># apply conditions only if they are present
</span><span>    @</span><span style="color:#bf616a;">people </span><span>= @</span><span style="color:#bf616a;">people</span><span>.where(q[</span><span style="color:#a3be8c;">:lastname</span><span>].matches(&quot;</span><span style="color:#a3be8c;">%</span><span>#{@</span><span style="color:#bf616a;">search</span><span>.lastname}</span><span style="color:#a3be8c;">%</span><span>&quot;)) </span><span style="color:#b48ead;">if </span><span>@</span><span style="color:#bf616a;">search</span><span>.lastname
</span><span>    @</span><span style="color:#bf616a;">people </span><span>= @</span><span style="color:#bf616a;">people</span><span>.where(q[</span><span style="color:#a3be8c;">:firstname</span><span>].matches(&quot;</span><span style="color:#a3be8c;">%</span><span>#{@</span><span style="color:#bf616a;">search</span><span>.firstname}</span><span style="color:#a3be8c;">%</span><span>&quot;)) </span><span style="color:#b48ead;">if </span><span>@</span><span style="color:#bf616a;">search</span><span>.firstname
</span><span>
</span><span>    </span><span style="color:#65737e;"># render index action, it&#39;s the same output, just filtered by conditions passed
</span><span>    render </span><span style="color:#a3be8c;">:index
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>Probably it’s not the best solution, perhaps this could be optimized with some helper, but it works, and helps to figure out how Arel works.</p>
<h3 id="webografy">Webografy:</h3>
<ul>
<li><a href="http://www.slideshare.net/GreggPollack/rails-3-beautiful-code-3219240">Greg Pollack: Rails 3 Beautiful Code</a></li>
<li><a href="http://railscasts.com/episodes/215-advanced-queries-in-rails-3">Ryan Bates: Advanced Queries in Rails 3</a></li>
</ul>
 </main>
    <footer class="root">
      <section class="container">
        <small
          >built with <i class="hearth">&#10084;</i> by Andrea
          <i>pavonz</i> Pavoni &copy;2010-2022</small
        >
      </section>
    </footer>
    <script
      data-goatcounter="https://pavonz.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
